#!/bin/bash

set -e

# Guest name
default_guest=vm1
# Guest RAM
default_ram=3934
# Guest disk size (GB)
default_disk=30
# Allocated CPUs to guest
default_vcpu=4
# Default console
default_tty=tty1

GUEST_NAME=${GUEST_NAME:-$default_guest}
GUEST_RAM=${GUEST_RAM:-$default_ram}
GUEST_DISK=${GUEST_DISK:-$default_disk}
GUEST_VCPU=${GUEST_VCPU:-$default_vcpu}
GUEST_TTY=${GUEST_TTY:-$default_tty}
SSH_KEY_FILE=~/.ssh/id_ed25519.pub
SSH_KEY_PUB=$(cat "$SSH_KEY_FILE")
USERNAME=perttu
PASSWORD=perttu
CACHE_PATH=~/.cache/guestvm
LIBVIRT_IMAGES_PATH=/var/lib/libvirt/images
DISK_FILE=ubuntu-20.04.1-live-server-amd64.iso

sudo virt-builder ubuntu-18.04 \
    --hostname "$GUEST_NAME" \
    --network \
    --timezone "Europe/Helsinki" \
    --size="${GUEST_DISK}G" \
    --format qcow2 -o /var/lib/libvirt/images/${GUEST_NAME}-disk01.qcow2 \
    --update \
    --firstboot-command "dpkg-reconfigure openssh-server" \
    --firstboot-command "useradd -p $(mkpasswd --method=sha512crypt $PASSWORD) -s /bin/bash -m -d /home/$USERNAME -G sudo $USERNAME" \
    --edit '/etc/default/grub:s/^GRUB_CMDLINE_LINUX_DEFAULT=.*/GRUB_CMDLINE_LINUX_DEFAULT="console=tty0 console=ttyS0,115200n8"/' \
    --ssh-inject "root:string:${SSH_KEY_PUB}" \
    --run-command update-grub 
