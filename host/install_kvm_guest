#!/bin/bash

set -e

# Guest name
default_guest=vm1
# Guest RAM
default_ram=3934
# Guest disk size (GB)
default_disk=30
# Allocated CPUs to guest
default_vcpu=4
# Default console
default_tty=tty1

GUEST_NAME=${GUEST_NAME:-$default_guest}
GUEST_RAM=${GUEST_RAM:-$default_ram}
GUEST_DISK=${GUEST_DISK:-$default_disk}
GUEST_VCPU=${GUEST_VCPU:-$default_vcpu}
GUEST_TTY=${GUEST_TTY:-$default_tty}
CACHE_PATH=~/.cache/guestvm
LIBVIRT_IMAGES_PATH=/var/lib/libvirt/images
DISK_FILE=ubuntu-20.04.1-live-server-amd64.iso
WWW_PATH=~/www
DISK_PATH=~/.kvm-images

mkdir -p $CACHE_PATH

if [ ! -f $CACHE_PATH/$DISK_FILE ]; then
    echo "Existing ubuntu disk image not found, downloading one..."
    pushd $CACHE_PATH
    wget http://releases.ubuntu.com/20.04/$DISK_FILE
    popd
fi

echo "Mounting the disk to /mnt"
sudo mount -r $CACHE_PATH/$DISK_FILE /mnt

echo "Writing the autoinstall config"

mkdir -p $WWW_PATH
pushd $WWW_PATH
cat > user-data << 'EOF'
#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: ubuntu-server
    password: "$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0"
    username: ubuntu
EOF
touch meta-data

echo "Launching python3 server in the background..."

python3 -m http.server 3003 &

# Wait for the server to become available
sleep 3

popd

mkdir -p $DISK_PATH

truncate -s 10G $DISK_PATH/$GUEST_NAME.img

kvm -no-reboot \
	-enable-kvm \
	-nographic \
	-cpu host \
	-m $GUEST_RAM \
	-drive file=$DISK_PATH/$GUEST_NAME.img,format=raw,cache=none,if=virtio \
	-cdrom $CACHE_PATH/$DISK_FILE \
	-kernel /mnt/casper/vmlinuz \
	-initrd /mnt/casper/initrd \
	-append 'autoinstall ds=nocloud-net;s=http://_gateway:3003/'
