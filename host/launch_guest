#!/bin/bash

set -e

# Guest name
default_guest=vm1
# Guest RAM
default_ram=3934
# Guest disk size (GB)
default_disk=30
# Allocated CPUs to guest
default_vcpu=4
# Default console
default_tty=tty1

GUEST_NAME=${GUEST_NAME:-$default_guest}
GUEST_RAM=${GUEST_RAM:-$default_ram}
GUEST_DISK=${GUEST_DISK:-$default_disk}
GUEST_VCPU=${GUEST_VCPU:-$default_vcpu}
GUEST_TTY=${GUEST_TTY:-$default_tty}
CACHE_PATH=~/.cache/guestvm
LIBVIRT_IMAGES_PATH=/var/lib/libvirt/images
DISK_FILE=ubuntu-20.04.1-live-server-amd64.iso

mkdir -p $CACHE_PATH

if [ ! -f $CACHE_PATH/$DISK_FILE ]; then
    echo "Existing ubuntu disk image not found, downloading one..."
    pushd ~/.cache/guestvm
    wget http://releases.ubuntu.com/20.04/$DISK_FILE
    popd
fi

CACHE_DIR=/home/$USER/.cache
sudo setfacl -m  u:libvirt-qemu:rwx $CACHE_DIR

sudo cp -n $CACHE_PATH/$DISK_FILE $LIBVIRT_IMAGES_PATH/
sudo chown libvirt-qemu:kvm $LIBVIRT_IMAGES_PATH/$DISK_FILE

virt-install --name $GUEST_NAME \
    --memory $GUEST_RAM \
    --vcpus $GUEST_VCPU \
    --cpu host \
    --virt-type kvm \
    --disk size=$GUEST_DISK \
    --graphics none \
    --os-variant ubuntu20.04 \
    --location $LIBVIRT_IMAGES_PATH/$DISK_FILE \
    --console $default_tty,target_type=virtio \
    --dry-run
