#!/bin/bash

set -e

default_username=perttu
default_password=perttu
default_tz="Europe/Helsinki"
rootfs=ubuntu-rootfs
rootfs_dir=~/$rootfs
rootfs_file=$rootfs.ext4
mntdir=/mnt/tmpdir
rootfs_username=${USERNAME:-$default_username}
rootfs_password=${PASSWORD:-$default_password}
rootfs_tz=${TIMEZONE:-$default_tz}
GREEN='\033[0;32m'
NC='\033[0m' # No Color

log_info() {
    printf "%(%Y-%m-%d %H:%M:%S)T - ${GREEN}INFO${NC} - $1\n"
}

# Create rootfs build directory
mkdir -p $rootfs_dir

log_info "Directory $rootfs_dir created, moving in"

cd $rootfs_dir

log_info "Downloading Ubuntu base"

# Download the Ubuntu base
curl -LOJ http://cdimage.ubuntu.com/ubuntu-base/releases/20.04/release/ubuntu-base-20.04.1-base-amd64.tar.gz

log_info "Allocating rootfs image"

# Allocate rootfs image
sudo dd if=/dev/zero of=$rootfs_file bs=1024 count=1M
sudo mkfs.ext4 -F -L linuxroot $rootfs_file

log_info "Mounting and setting up the image"
sudo mkdir -p $mntdir
sudo mount -o loop $rootfs_file $mntdir

# Unpack the downloaded Ubuntu base image
sudo tar zxvf ubuntu-*.tar.gz -C $mntdir

# Setup the image
sudo cp /etc/resolv.conf $mntdir/etc/
sudo mount -t proc /proc $mntdir/proc
sudo mount -t sysfs /sys $mntdir/sys
sudo mount -o bind /dev $mntdir/dev
sudo mount -o bind /dev/pts $mntdir/dev/pts

log_info "Going in the image..."

# Run inside the image
sudo chroot $mntdir /bin/bash <<"EOT"

# Install packages
apt-get update
apt-get install -y \
    language-pack-en-base \
    sudo \
    ssh \
    net-tools \
    ethtool \
    wireless-tools \
    ifupdown \
    network-manager \
    iputils-ping \
    rsyslog \
    htop \
    vim \
    xinit xorg \
    alsa-utils \
    sudo \
    --no-install-recommends

# Create user with home directory
# useradd -m dogentu
useradd -m -p $(openssl passwd -1 $rootfs_password) $rootfs_username
# Add password for user
# passwd dogentu
# Add to sudoers
usermod -aG sudo dogentu
# Add root password
# passwd

hostname=fvm
hosts=$(cat <<EOF
127.0.0.1   localhost
127.0.0.1   $hostname
EOF
)
# Setup hostname
echo "$hostname" > /etc/hostname
echo "$hosts" > /etc/hosts

## Make X used by ‘anyuser’
echo "allowed_users=anybody" > /etc/X11/Xwrapper.config

# Configure timezone
# dpkg-reconfigure tzdata
cp "/usr/share/zoneinfo/$rootfs_tz" /etc/localtime

# Set up group for alsa
# vim /etc/group
# Change 'audio:x:29' and 'video:x:44' to:
# audio:x:29:pulse,dogentu
# video:x:44:dogentu

# Set up group for fbterm
# vim /etc/group

# Exit at this point from chroot:
# exit

EOT

log_info "Done. Unmounting..."

# Unmount
sudo umount $mntdir/proc
sudo umount $mntdir/sys
sudo umount $mntdir/dev/pts
sudo umount $mntdir/dev

log_info "Unmounting done. Moving out of $(pwd)"


log_info "All set"

# rootfs=$rootfs_file
# append="root=/dev/sda console=ttyS0"
# kernel=vmlinuz-5.5.0-rc7+
# initrd=initrd.img-5.5.0-rc7+

# firectl \
#     --kernel=../firecracker-guest/hello-vmlinux.bin \
#     --root-drive=$rootfs_file \
#     --kernel-opts="root=/dev/sda ro console=ttyS0 noapic reboot=k panic=1 pci=off nomodules"
# qemu-system-x86_64 -m 1024M -nographic -kernel $kernel -append "$append" -hda $rootfs -net nic
